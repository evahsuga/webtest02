<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ–ãƒ­ã‚°ä½œæˆæ”¯æ´ã‚¢ãƒ—ãƒª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Sans', 'Yu Gothic UI', sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: white;
            padding: 20px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            font-size: 2.5rem;
            font-weight: 300;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #34495e;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3498db;
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        button:hover {
            background: #2980b9;
        }

        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .outline-section {
            margin-top: 20px;
        }

        .outline-item {
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 0 5px 5px 0;
        }

        .outline-item h3 {
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .outline-item p {
            color: #7f8c8d;
            font-size: 14px;
        }

        .editor {
            grid-column: 1 / -1;
        }

        .editor textarea {
            min-height: 400px;
            font-family: 'Courier New', monospace;
        }

        .hidden {
            display: none;
        }

        .article-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .article-item {
            background: white;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #3498db;
            cursor: pointer;
            transition: all 0.3s;
        }

        .article-item:hover {
            background: #e8f4f8;
            transform: translateX(5px);
        }

        .article-item h4 {
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        .article-item .article-date {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .article-item .article-preview {
            color: #555;
            font-size: 0.9rem;
            margin-top: 8px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .heading-item {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .heading-item:hover {
            border-color: #3498db;
            background: #e8f4f8;
        }

        .heading-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .heading-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 500;
        }

        .heading-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }

        .heading-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            align-items: center;
        }

        .drag-handle {
            cursor: grab;
            padding: 5px;
            color: #666;
            font-size: 18px;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .delete-heading {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .delete-heading:hover {
            background: #c0392b;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>ãƒ–ãƒ­ã‚°ä½œæˆæ”¯æ´ã‚¢ãƒ—ãƒª</h1>
        </div>
    </header>

    <div class="container">
        <div class="main-content">
            <!-- è©±é¡Œãƒ’ã‚¢ãƒªãƒ³ã‚° -->
            <div class="card" id="topicCard">
                <h2>ğŸ“ è©±é¡Œã‚’ãŠèã‹ã›ãã ã•ã„</h2>
                <div class="form-group">
                    <label for="topic">æ›¸ããŸã„è©±é¡Œãƒ»ãƒ†ãƒ¼ãƒ</label>
                    <input type="text" id="topic" placeholder="ä¾‹ï¼šãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°å­¦ç¿’ã«ã¤ã„ã¦">
                </div>
                <div class="form-group">
                    <label for="referenceUrl">å‚è€ƒè¨˜äº‹URLï¼ˆä»»æ„ï¼‰</label>
                    <input type="url" id="referenceUrl" placeholder="å‚è€ƒã«ã—ãŸã„è¨˜äº‹ã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šhttps://example.com/articleï¼‰">
                </div>
                <div class="form-group">
                    <label for="purpose">è¨˜äº‹ã®ç›®çš„</label>
                    <textarea id="purpose" placeholder="ã“ã®è¨˜äº‹ã§èª­è€…ã«ä½•ã‚’ä¼ãˆãŸã„ã‹ã€ã©ã‚“ãªä¾¡å€¤ã‚’æä¾›ã—ãŸã„ã‹ã‚’æ•™ãˆã¦ãã ã•ã„"></textarea>
                </div>
                <div class="form-group">
                    <label for="experience">é–¢é€£ã™ã‚‹çµŒé¨“ãƒ»çŸ¥è­˜</label>
                    <textarea id="experience" placeholder="ã“ã®è©±é¡Œã«é–¢ã™ã‚‹ã‚ãªãŸã®çµŒé¨“ã‚„å°‚é–€çŸ¥è­˜ãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„"></textarea>
                </div>
                <div class="form-group" style="background-color: #f0f8ff; padding: 15px; border-radius: 8px; border: 2px solid #3498db;">
                    <label for="keywords" style="color: #2c3e50; font-weight: bold;">ğŸ¯ ãƒ¡ã‚¤ãƒ³ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="text" id="keywords" placeholder="è¨˜äº‹ã®ãƒ¡ã‚¤ãƒ³ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°å­¦ç¿’ï¼‰" style="border: 2px solid #3498db;">
                </div>
                <div class="form-group" style="background-color: #f0f8ff; padding: 15px; border-radius: 8px; border: 2px solid #3498db;">
                    <label for="subKeywords" style="color: #2c3e50; font-weight: bold;">ğŸ”— ã‚µãƒ–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="text" id="subKeywords" placeholder="é–¢é€£ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šåˆå¿ƒè€…, å­¦ç¿’æ–¹æ³•, åŠ¹ç‡çš„ï¼‰" style="border: 2px solid #3498db;">
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="generateOutline()">æ§‹æˆã‚’ææ¡ˆã—ã¦ã‚‚ã‚‰ã†</button>
                    <button onclick="showSavedArticlesList()" style="background: #27ae60;">ğŸ“š ä¿å­˜æ¸ˆã¿è¨˜äº‹ä¸€è¦§</button>
                </div>
                <div id="topArticlesList" class="article-list hidden"></div>
            </div>

            <!-- æ§‹æˆææ¡ˆ -->
            <div class="card" id="outlineCard">
                <h2>ğŸ“‹ è¨˜äº‹æ§‹æˆæ¡ˆ</h2>
                <div id="outlineContent">
                    <p style="color: #7f8c8d; text-align: center; padding: 40px 0;">
                        å·¦å´ã®ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›ã—ã¦ã€Œæ§‹æˆã‚’ææ¡ˆã—ã¦ã‚‚ã‚‰ã†ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„
                    </p>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                    <button onclick="showHeadingEditor()" id="editHeadingsBtn" class="hidden" style="background: #f39c12; color: white;">ğŸ“ è¦‹å‡ºã—ã‚’ç·¨é›†ã™ã‚‹</button>
                    <button onclick="startWriting()" id="startWritingBtn" class="hidden" style="background: #e74c3c; color: white;">âœï¸ ã“ã®æ§‹æˆã§è¨˜äº‹ã‚’æ›¸ã</button>
                </div>
            </div>
        </div>

        <!-- è¦‹å‡ºã—ç·¨é›†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="card editor hidden" id="headingEditorCard">
            <h2>ğŸ“ è¦‹å‡ºã—ã‚’ç·¨é›†</h2>
            <p style="color: #666; margin-bottom: 20px;">ç”Ÿæˆã•ã‚ŒãŸè¦‹å‡ºã—ã‚’è‡ªç”±ã«ç·¨é›†ã§ãã¾ã™ã€‚é †ç•ªã®å¤‰æ›´ã‚„æ–‡è¨€ã®ä¿®æ­£ãŒå¯èƒ½ã§ã™ã€‚</p>
            <div id="headingsList"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="addNewHeading()" style="background: #27ae60;">â• è¦‹å‡ºã—ã‚’è¿½åŠ </button>
                <button onclick="confirmHeadings()" style="background: #e74c3c; color: white;">âœ… ã“ã®è¦‹å‡ºã—ã§è¨˜äº‹ã‚’ä½œæˆ</button>
                <button onclick="backToOutline()" style="background: #95a5a6;">â¬…ï¸ æ§‹æˆæ¡ˆã«æˆ»ã‚‹</button>
            </div>
        </div>

        <!-- è¨˜äº‹ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ -->
        <div class="card editor hidden" id="editorCard">
            <h2>âœï¸ è¨˜äº‹ã‚’æ›¸ã</h2>
            <div class="form-group">
                <label for="title">è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«</label>
                <input type="text" id="title" placeholder="è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›">
            </div>
            <div class="form-group">
                <label for="content">è¨˜äº‹å†…å®¹ï¼ˆMarkdownå½¢å¼ï¼‰</label>
                <textarea id="content" placeholder="ã“ã“ã«è¨˜äº‹ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚Markdownè¨˜æ³•ãŒä½¿ãˆã¾ã™ã€‚"></textarea>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="saveArticle()">è¨˜äº‹ã‚’ä¿å­˜</button>
                <button onclick="previewArticle()">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
                <button onclick="showSavedArticlesList()">ä¿å­˜æ¸ˆã¿è¨˜äº‹ä¸€è¦§</button>
                <button onclick="loadSavedArticles()" style="background: #27ae60;">è¨˜äº‹ã‚’èª­ã¿è¾¼ã¿</button>
                <button onclick="debugLocalStorage()" style="background: #f39c12; font-size: 12px;">ãƒ‡ãƒ¼ã‚¿ç¢ºèª</button>
                <button onclick="clearAllArticles()" style="background: #e74c3c; font-size: 12px;">å…¨å‰Šé™¤</button>
            </div>
            <div id="articlesList" class="article-list hidden"></div>
        </div>
    </div>

    <script>
        // ãƒ–ãƒ­ã‚°æ§‹æˆææ¡ˆæ©Ÿèƒ½
        async function generateOutline() {
            const topic = document.getElementById('topic').value;
            const purpose = document.getElementById('purpose').value;
            const experience = document.getElementById('experience').value;
            const referenceUrl = document.getElementById('referenceUrl').value;
            const keywords = document.getElementById('keywords').value;
            const subKeywords = document.getElementById('subKeywords').value;

            if (!topic || !purpose) {
                alert('è©±é¡Œãƒ»ãƒ†ãƒ¼ãƒã¨è¨˜äº‹ã®ç›®çš„ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // å‚è€ƒURLã‹ã‚‰ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—
            let referenceContent = '';
            if (referenceUrl) {
                try {
                    const fetchButton = document.querySelector('button[onclick="generateOutline()"]');
                    fetchButton.disabled = true;
                    fetchButton.textContent = 'å‚è€ƒè¨˜äº‹ã‚’èª­ã¿è¾¼ã¿ä¸­...';
                    
                    referenceContent = await fetchReferenceContent(referenceUrl);
                    
                    // å–å¾—ã—ãŸå†…å®¹ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜
                    window.currentReferenceContent = referenceContent;
                    console.log('å‚è€ƒè¨˜äº‹ã®å†…å®¹ã‚’å–å¾—ã—ã¾ã—ãŸ:', referenceContent);
                    
                } catch (error) {
                    console.error('å‚è€ƒè¨˜äº‹ã®å–å¾—ã«å¤±æ•—:', error);
                    alert('å‚è€ƒè¨˜äº‹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚URLã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                } finally {
                    document.querySelector('button[onclick="generateOutline()"]').disabled = false;
                    document.querySelector('button[onclick="generateOutline()"]').textContent = 'æ§‹æˆã‚’ææ¡ˆã—ã¦ã‚‚ã‚‰ã†';
                }
            }

            // ã‚·ãƒ³ãƒ—ãƒ«ãªæ§‹æˆç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ï¼ˆä¸€èˆ¬å‘ã‘ã«å›ºå®šï¼‰
            const outline = generateBlogOutline(topic, 'general', purpose, experience, referenceContent, keywords, subKeywords);
            displayOutline(outline);
        }

        // å‚è€ƒè¨˜äº‹ã‹ã‚‰ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—ã™ã‚‹é–¢æ•°
        async function fetchReferenceContent(url) {
            // ã‚·ãƒ³ãƒ—ãƒ«ãªURLæ¤œè¨¼
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                throw new Error('æœ‰åŠ¹ãªURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            }
            
            try {
                // WebFetch APIã‚’ä½¿ç”¨ã—ã¦è¨˜äº‹å†…å®¹ã‚’å–å¾—
                const response = await fetch('/api/webfetch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: url,
                        prompt: 'è¨˜äº‹ã®ä¸»è¦ãªå†…å®¹ã‚’è¦ç´„ã—ã€ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚ç‰¹ã«é‡è¦ãªäº‹å®Ÿã€ãƒ‡ãƒ¼ã‚¿ã€ä¸»å¼µã«ã¤ã„ã¦è©³ã—ãæ•™ãˆã¦ãã ã•ã„ã€‚'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                return data.content || `å‚è€ƒè¨˜äº‹URL: ${url}`;
                
            } catch (error) {
                console.error('WebFetch APIã‚¨ãƒ©ãƒ¼:', error);
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç›´æ¥WebFetché–¢æ•°ã‚’è©¦è¡Œ
                try {
                    return await webFetchDirect(url);
                } catch (fallbackError) {
                    console.error('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', fallbackError);
                    return `å‚è€ƒè¨˜äº‹URL: ${url}\nâ€»è¨˜äº‹å†…å®¹ã®è‡ªå‹•å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
                }
            }
        }
        
        // WebFetché–¢æ•°ã®ç›´æ¥å‘¼ã³å‡ºã—
        async function webFetchDirect(url) {
            // ã“ã®éƒ¨åˆ†ã¯å®Ÿéš›ã®WebFetchæ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã«ä½¿ç”¨
            // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ä»®å®Ÿè£…
            return new Promise((resolve) => {
                setTimeout(() => {
                    resolve(`å‚è€ƒè¨˜äº‹ã®å†…å®¹:\n- URL: ${url}\n- ã“ã®è¨˜äº‹ã®ä¸»è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’å‚è€ƒã«ã—ã¦è¨˜äº‹ã‚’ä½œæˆã—ã¦ãã ã•ã„\n- è¨˜äº‹ã®æ§‹æˆã‚„è«–ç‚¹ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„`);
                }, 2000);
            });
        }

        function generateBlogOutline(topic, target, purpose, experience, referenceContent = '', keywords = '', subKeywords = '') {
            // å¸¸ã«ä¸€èˆ¬å‘ã‘ã«å›ºå®š
            const targetText = 'ä¸€èˆ¬ã®æ–¹';

            // AIã«ã‚ˆã‚‹ã€Œã¯ã˜ã‚ã«ã€æ–‡ç« ç”Ÿæˆï¼ˆå‚è€ƒè¨˜äº‹å†…å®¹ã‚’å«ã‚€ï¼‰
            const introText = generateIntroText(topic, 'general', purpose, experience, referenceContent);

            // å‚è€ƒè¨˜äº‹ãŒã‚ã‚‹å ´åˆã¯ã€ã‚ˆã‚Šè©³ç´°ãªæ§‹æˆã‚’ç”Ÿæˆ
            const sections = generateSectionsWithReference(topic, purpose, experience, referenceContent, keywords, subKeywords);

            return {
                title: `${targetText}å‘ã‘ï¼š${topic}ã«ã¤ã„ã¦`,
                referenceContent: referenceContent,
                keywords: keywords,
                subKeywords: subKeywords,
                sections: sections
            };
        }

        // å‚è€ƒè¨˜äº‹ã‚’è€ƒæ…®ã—ãŸè¨˜äº‹æ§‹æˆç”Ÿæˆï¼ˆSEOæœ€é©åŒ–ï¼‰
        function generateSectionsWithReference(topic, purpose, experience, referenceContent, keywords = '', subKeywords = '') {
            // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ã‚µãƒ–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’é…åˆ—ã«å¤‰æ›
            const mainKeyword = keywords.trim();
            const subKeywordArray = subKeywords ? subKeywords.split(',').map(k => k.trim()).filter(k => k) : [];
            
            const baseSections = [
                {
                    title: 'ã¯ã˜ã‚ã«',
                    content: generateIntroText(topic, 'general', purpose, experience, referenceContent)
                }
            ];

            // SEOæœ€é©åŒ–ã•ã‚ŒãŸä¸­é …ç›®ã‚’ç”Ÿæˆ
            const seoSections = generateSEOOptimizedSections(topic, mainKeyword, subKeywordArray, purpose, experience, referenceContent);
            baseSections.push(...seoSections);

            // ã¾ã¨ã‚ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒ¡ã‚¤ãƒ³ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å«ã‚€ï¼‰
            const summaryTitle = mainKeyword ? 
                `${mainKeyword}ã«é–¢ã™ã‚‹ã¾ã¨ã‚` : 
                'ã¾ã¨ã‚';
            baseSections.push({
                title: summaryTitle,
                content: 'è¨˜äº‹ã®è¦ç‚¹ã‚’ã¾ã¨ã‚ã€èª­è€…ã¸ã®æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ææ¡ˆ'
            });

            return baseSections;
        }

        // SEOæœ€é©åŒ–ã•ã‚ŒãŸä¸­é …ç›®ç”Ÿæˆ
        function generateSEOOptimizedSections(topic, mainKeyword, subKeywords, purpose, experience, referenceContent) {
            const sections = [];
            
            // 2. åŸºæœ¬æ¦‚å¿µã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒ¡ã‚¤ãƒ³ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å«ã‚€ï¼‰
            const basicTitle = mainKeyword ? 
                `${mainKeyword}ã¨ã¯ï¼ŸåŸºæœ¬çš„ãªæ¦‚å¿µã‚’è§£èª¬` : 
                `${topic}ã¨ã¯ï¼Ÿ`;
            sections.push({
                title: basicTitle,
                content: referenceContent ? 
                    `${topic}ã®åŸºæœ¬çš„ãªæ¦‚å¿µã«ã¤ã„ã¦ã€å‚è€ƒè¨˜äº‹ã®å†…å®¹ã‚‚è¸ã¾ãˆã¦è©³ã—ãè§£èª¬ã—ã¾ã™ã€‚` :
                    'åŸºæœ¬çš„ãªæ¦‚å¿µã‚„å®šç¾©ã‚’èª¬æ˜'
            });

            // 3. ã‚µãƒ–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ´»ç”¨ã—ãŸä¸­é …ç›®ç”Ÿæˆï¼ˆæœ€å¤§3ã¤ï¼‰
            if (subKeywords.length > 0) {
                // ä¸­é …ç›®ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®šç¾©ï¼ˆè¤‡æ•°ã®ã‚µãƒ–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’çµ„ã¿åˆã‚ã›å¯èƒ½ï¼‰
                const sectionPatterns = [
                    {
                        titleTemplate: (sub1, sub2, keyword) => sub2 ? 
                            `${sub1}ã¨${sub2}ã‹ã‚‰å­¦ã¶${keyword || topic}ã®åŸºæœ¬` :
                            `${sub1}ã«ãŠã‘ã‚‹${keyword || topic}ã®é‡è¦ãƒã‚¤ãƒ³ãƒˆ`,
                        contentTemplate: (sub1, sub2, keyword) => sub2 ?
                            `${sub1}ã¨${sub2}ã®ä¸¡æ–¹ã®è¦³ç‚¹ã‹ã‚‰${keyword || topic}ã«ã¤ã„ã¦è©³ã—ãè§£èª¬ã—ã¾ã™ã€‚` :
                            `${sub1}ã®è¦³ç‚¹ã‹ã‚‰${keyword || topic}ã«ã¤ã„ã¦è©³ã—ãè§£èª¬ã—ã¾ã™ã€‚`
                    },
                    {
                        titleTemplate: (sub1, sub2, keyword) => sub2 ?
                            `${sub1}ã¨${sub2}ã‚’æ´»ç”¨ã—ãŸ${keyword || topic}ã®å®Ÿè·µæ–¹æ³•` :
                            `${sub1}ã§å­¦ã¶${keyword || topic}ã®å®Ÿè·µæ–¹æ³•`,
                        contentTemplate: (sub1, sub2, keyword) => sub2 ?
                            `${sub1}ã¨${sub2}ã‚’çµ„ã¿åˆã‚ã›ã¦${keyword || topic}ã‚’å®Ÿè·µã™ã‚‹å…·ä½“çš„ãªæ–¹æ³•ã‚’ã”ç´¹ä»‹ã—ã¾ã™ã€‚` :
                            `${sub1}ã‚’é€šã˜ã¦${keyword || topic}ã‚’å®Ÿè·µã™ã‚‹å…·ä½“çš„ãªæ–¹æ³•ã‚’ã”ç´¹ä»‹ã—ã¾ã™ã€‚`
                    },
                    {
                        titleTemplate: (sub1, sub2, keyword) => sub2 ?
                            `${sub1}Ã—${sub2}ã§å®Ÿç¾ã™ã‚‹${keyword || topic}ã®å¿œç”¨ä¾‹` :
                            `${sub1}ã‚’æ´»ç”¨ã—ãŸ${keyword || topic}ã®å¿œç”¨ä¾‹`,
                        contentTemplate: (sub1, sub2, keyword) => sub2 ?
                            `${sub1}ã¨${sub2}ã‚’çµ„ã¿åˆã‚ã›ãŸ${keyword || topic}ã®å¿œç”¨ä¾‹ã‚„æˆåŠŸäº‹ä¾‹ã‚’ã”ç´¹ä»‹ã—ã¾ã™ã€‚` :
                            `${sub1}ã‚’æ´»ç”¨ã—ãŸ${keyword || topic}ã®å¿œç”¨ä¾‹ã‚„äº‹ä¾‹ã‚’ã”ç´¹ä»‹ã—ã¾ã™ã€‚`
                    }
                ];

                // æœ€å¤§3ã¤ã®ä¸­é …ç›®ã‚’ç”Ÿæˆ
                const maxSections = Math.min(3, sectionPatterns.length);
                
                for (let i = 0; i < maxSections; i++) {
                    const pattern = sectionPatterns[i];
                    const firstSub = subKeywords[i] || subKeywords[0]; // åŸºæœ¬ã¯é †ç•ªã«ã€è¶³ã‚Šãªã„å ´åˆã¯æœ€åˆã®ã‚‚ã®ã‚’å†åˆ©ç”¨
                    const secondSub = subKeywords.length > 1 && i < subKeywords.length - 1 ? 
                        subKeywords[i + 1] : 
                        (subKeywords.length > 2 ? subKeywords[(i + 1) % subKeywords.length] : null);
                    
                    sections.push({
                        title: pattern.titleTemplate(firstSub, secondSub, mainKeyword),
                        content: pattern.contentTemplate(firstSub, secondSub, mainKeyword)
                    });
                }
            } else {
                // ã‚µãƒ–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒãªã„å ´åˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæœ€å¤§3ã¤ï¼‰
                sections.push({
                    title: experience ? 'ç§ã®çµŒé¨“ã‹ã‚‰å­¦ã¶ãƒã‚¤ãƒ³ãƒˆ' : 'å…·ä½“ä¾‹ãƒ»äº‹ä¾‹',
                    content: experience || 'å®Ÿéš›ã®ä¾‹ã‚„äº‹ä¾‹ã‚’ç´¹ä»‹'
                });

                sections.push({
                    title: `${mainKeyword || topic}ã‚’åŠ¹æœçš„ã«æ´»ç”¨ã™ã‚‹æ–¹æ³•`,
                    content: 'åŠ¹æœçš„ã«é€²ã‚ã‚‹ãŸã‚ã®ãƒã‚¤ãƒ³ãƒˆã‚„ã‚³ãƒ„ã‚’ã”ç´¹ä»‹ã—ã¾ã™ã€‚'
                });

                sections.push({
                    title: `${mainKeyword || topic}ã®å®Ÿè·µã¨å¿œç”¨`,
                    content: 'å®Ÿéš›ã®ç¾å ´ã§ã®æ´»ç”¨ä¾‹ã‚„å¿œç”¨æ–¹æ³•ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚'
                });
            }

            // å‚è€ƒè¨˜äº‹ãŒã‚ã‚‹å ´åˆã¯ã€æ—¢å­˜ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®1ã¤ã¨ç½®ãæ›ãˆã‚‹ï¼ˆä¸­é …ç›®ã¯æœ€å¤§3ã¤ç¶­æŒï¼‰
            if (referenceContent && referenceContent.length > 100 && sections.length >= 3) {
                // æœ€å¾Œã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚è€ƒè¨˜äº‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ç½®ãæ›ãˆ
                sections[sections.length - 1] = {
                    title: `${mainKeyword || topic}ã«ã¤ã„ã¦å‚è€ƒè¨˜äº‹ã‹ã‚‰å­¦ã¶ãƒã‚¤ãƒ³ãƒˆ`,
                    content: 'å‚è€ƒè¨˜äº‹ã®é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’åˆ†æã—ã€èª­è€…ã«å½¹ç«‹ã¤æƒ…å ±ã‚’æŠ½å‡ºã—ã¾ã™ã€‚'
                };
            } else if (referenceContent && referenceContent.length > 100 && sections.length < 3) {
                // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒ3ã¤æœªæº€ã®å ´åˆã¯è¿½åŠ 
                sections.push({
                    title: `${mainKeyword || topic}ã«ã¤ã„ã¦å‚è€ƒè¨˜äº‹ã‹ã‚‰å­¦ã¶ãƒã‚¤ãƒ³ãƒˆ`,
                    content: 'å‚è€ƒè¨˜äº‹ã®é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’åˆ†æã—ã€èª­è€…ã«å½¹ç«‹ã¤æƒ…å ±ã‚’æŠ½å‡ºã—ã¾ã™ã€‚'
                });
            }

            return sections;
        }

        function displayOutline(outline) {
            const outlineContent = document.getElementById('outlineContent');
            const html = `
                <div class="outline-item">
                    <h3>ğŸ“° ææ¡ˆã‚¿ã‚¤ãƒˆãƒ«</h3>
                    <p>${outline.title}</p>
                </div>
                ${outline.sections.map((section, index) => `
                    <div class="outline-item">
                        <h3>${index + 1}. ${section.title}</h3>
                        <p>${section.content}</p>
                    </div>
                `).join('')}
            `;
            outlineContent.innerHTML = html;
            
            // ç”Ÿæˆã•ã‚ŒãŸæ§‹æˆã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜
            window.currentOutline = outline;
            
            // ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            const editBtn = document.getElementById('editHeadingsBtn');
            const startBtn = document.getElementById('startWritingBtn');
            
            if (editBtn) {
                editBtn.classList.remove('hidden');
                editBtn.style.display = 'inline-block';
                editBtn.style.visibility = 'visible';
                editBtn.style.opacity = '1';
                console.log('è¦‹å‡ºã—ç·¨é›†ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
                
                // ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
                editBtn.addEventListener('click', function() {
                    console.log('è¦‹å‡ºã—ç·¨é›†ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
                    showHeadingEditor();
                });
            }
            
            if (startBtn) {
                startBtn.classList.remove('hidden');
                startBtn.style.display = 'inline-block';
                startBtn.style.visibility = 'visible';
                startBtn.style.opacity = '1';
                console.log('è¨˜äº‹ä½œæˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
            }
        }

        // è¦‹å‡ºã—ç·¨é›†æ©Ÿèƒ½
        function showHeadingEditor() {
            console.log('è¦‹å‡ºã—ç·¨é›†æ©Ÿèƒ½ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ');
            console.log('ç¾åœ¨ã®æ§‹æˆ:', window.currentOutline);
            
            if (!window.currentOutline) {
                alert('æ§‹æˆæ¡ˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…ˆã«æ§‹æˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            // è¦‹å‡ºã—ç·¨é›†ç”»é¢ã‚’è¡¨ç¤º
            const editorCard = document.getElementById('headingEditorCard');
            if (editorCard) {
                editorCard.classList.remove('hidden');
                console.log('è¦‹å‡ºã—ç·¨é›†ç”»é¢ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
            } else {
                console.error('è¦‹å‡ºã—ç·¨é›†ç”»é¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // è¦‹å‡ºã—ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
            displayHeadingsEditor();
            
            // è¦‹å‡ºã—ç·¨é›†ç”»é¢ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            setTimeout(() => {
                editorCard.scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        function displayHeadingsEditor() {
            const headingsList = document.getElementById('headingsList');
            const outline = window.currentOutline;
            
            // ç·¨é›†å¯èƒ½ãªè¦‹å‡ºã—ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
            let headingsHTML = '';
            
            // ã‚¿ã‚¤ãƒˆãƒ«
            headingsHTML += `
                <div class="heading-item" data-type="title">
                    <div class="heading-controls">
                        <span class="drag-handle">ğŸ“°</span>
                        <span style="font-weight: bold; color: #2c3e50;">è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«</span>
                    </div>
                    <input type="text" class="heading-input" value="${outline.title}" data-index="title">
                </div>
            `;
            
            // å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¦‹å‡ºã—
            outline.sections.forEach((section, index) => {
                headingsHTML += `
                    <div class="heading-item" data-type="section" data-index="${index}">
                        <div class="heading-controls">
                            <span class="drag-handle">â‹®â‹®</span>
                            <span style="font-weight: bold; color: #34495e;">##${index + 1}</span>
                            <button class="delete-heading" onclick="deleteHeading(${index})">å‰Šé™¤</button>
                        </div>
                        <input type="text" class="heading-input" value="${section.title}" data-index="${index}">
                    </div>
                `;
            });
            
            headingsList.innerHTML = headingsHTML;
            
            // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–
            enableDragAndDrop();
        }

        function enableDragAndDrop() {
            const headingItems = document.querySelectorAll('.heading-item[data-type="section"]');
            headingItems.forEach(item => {
                item.draggable = true;
                
                item.addEventListener('dragstart', (e) => {
                    item.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', item.dataset.index);
                });
                
                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                });
                
                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });
                
                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const draggedIndex = parseInt(e.dataTransfer.getData('text/plain'));
                    const targetIndex = parseInt(item.dataset.index);
                    
                    if (draggedIndex !== targetIndex) {
                        reorderHeadings(draggedIndex, targetIndex);
                    }
                });
            });
        }

        function reorderHeadings(fromIndex, toIndex) {
            const outline = window.currentOutline;
            const sections = outline.sections;
            
            // é…åˆ—ã®è¦ç´ ã‚’ç§»å‹•
            const [movedSection] = sections.splice(fromIndex, 1);
            sections.splice(toIndex, 0, movedSection);
            
            // è¡¨ç¤ºã‚’æ›´æ–°
            displayHeadingsEditor();
        }

        function deleteHeading(index) {
            if (confirm('ã“ã®è¦‹å‡ºã—ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                window.currentOutline.sections.splice(index, 1);
                displayHeadingsEditor();
            }
        }

        function addNewHeading() {
            const newHeading = prompt('æ–°ã—ã„è¦‹å‡ºã—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š');
            if (newHeading && newHeading.trim()) {
                window.currentOutline.sections.push({
                    title: newHeading.trim(),
                    content: 'æ–°ã—ãè¿½åŠ ã•ã‚ŒãŸã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚'
                });
                displayHeadingsEditor();
            }
        }

        function confirmHeadings() {
            // ç·¨é›†ã•ã‚ŒãŸè¦‹å‡ºã—ã‚’å–å¾—
            const titleInput = document.querySelector('input[data-index="title"]');
            const sectionInputs = document.querySelectorAll('.heading-item[data-type="section"] .heading-input');
            
            // ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
            if (titleInput) {
                window.currentOutline.title = titleInput.value;
            }
            
            // ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¦‹å‡ºã—ã‚’æ›´æ–°
            sectionInputs.forEach((input, index) => {
                if (window.currentOutline.sections[index]) {
                    window.currentOutline.sections[index].title = input.value;
                }
            });
            
            // è¦‹å‡ºã—ç·¨é›†ç”»é¢ã‚’éè¡¨ç¤º
            document.getElementById('headingEditorCard').classList.add('hidden');
            
            // æ›´æ–°ã•ã‚ŒãŸæ§‹æˆã‚’è¡¨ç¤º
            displayOutline(window.currentOutline);
            
            // è¨˜äº‹ä½œæˆã«é€²ã‚€
            startWriting();
        }

        function backToOutline() {
            document.getElementById('headingEditorCard').classList.add('hidden');
        }

        function startWriting() {
            document.getElementById('editorCard').classList.remove('hidden');
            
            // ç¾åœ¨ã®æ§‹æˆã‹ã‚‰æƒ…å ±ã‚’å–å¾—ï¼ˆç·¨é›†æ¸ˆã¿ã®å¯èƒ½æ€§ã‚ã‚Šï¼‰
            const outline = window.currentOutline;
            const title = outline ? outline.title : document.querySelector('.outline-item p').textContent;
            document.getElementById('title').value = title;
            
            // ãƒ’ã‚¢ãƒªãƒ³ã‚°å†…å®¹ã‚’å–å¾—
            const topic = document.getElementById('topic').value;
            const purpose = document.getElementById('purpose').value;
            const experience = document.getElementById('experience').value;
            const referenceUrl = document.getElementById('referenceUrl').value;
            const keywords = document.getElementById('keywords').value;
            const subKeywords = document.getElementById('subKeywords').value;
            
            // æ§‹æˆã‚’åŸºã«ã—ãŸè¨˜äº‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç”Ÿæˆï¼ˆç·¨é›†æ¸ˆã¿è¦‹å‡ºã—ã‚’ä½¿ç”¨ï¼‰
            let template = '';
            
            // ãƒ’ã‚¢ãƒªãƒ³ã‚°å†…å®¹ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦è¨˜äº‹ã®å†’é ­ã«è¿½åŠ 
            template += `<!-- ãƒ’ã‚¢ãƒªãƒ³ã‚°å†…å®¹ -->\n`;
            template += `<!-- è©±é¡Œãƒ»ãƒ†ãƒ¼ãƒ: ${topic} -->\n`;
            template += `<!-- æƒ³å®šèª­è€…: ä¸€èˆ¬ã®æ–¹ -->\n`;
            template += `<!-- è¨˜äº‹ã®ç›®çš„: ${purpose} -->\n`;
            if (experience) {
                template += `<!-- é–¢é€£ã™ã‚‹çµŒé¨“ãƒ»çŸ¥è­˜: ${experience} -->\n`;
            }
            if (keywords) {
                template += `<!-- ãƒ¡ã‚¤ãƒ³ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${keywords} -->\n`;
            }
            if (subKeywords) {
                template += `<!-- ã‚µãƒ–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${subKeywords} -->\n`;
            }
            if (referenceUrl) {
                template += `<!-- å‚è€ƒè¨˜äº‹URL: ${referenceUrl} -->\n`;
                // å‚è€ƒè¨˜äº‹ã®å†…å®¹ãŒå–å¾—ã•ã‚Œã¦ã„ã‚‹å ´åˆ
                const storedReferenceContent = window.currentReferenceContent;
                if (storedReferenceContent && storedReferenceContent.length > 100) {
                    template += `<!-- å‚è€ƒè¨˜äº‹ã®è¦ç´„: ${storedReferenceContent.substring(0, 200)}... -->\n`;
                }
            }
            template += `\n`;
            
            // ç·¨é›†æ¸ˆã¿ã®æ§‹æˆã‚’ä½¿ç”¨ã—ã¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç”Ÿæˆ
            if (outline && outline.sections) {
                outline.sections.forEach((section, index) => {
                    const sectionTitle = section.title;
                    const sectionContent = section.content;
                    
                    if (sectionTitle.includes('ã¯ã˜ã‚ã«')) {
                        // ã€Œã¯ã˜ã‚ã«ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã¯ç”Ÿæˆã•ã‚ŒãŸæ–‡ç« ã‚’æŒ¿å…¥
                        template += `## ${sectionTitle}\n\n${sectionContent}\n\n`;
                    } else if (sectionTitle.includes('ç§ã®çµŒé¨“ã‹ã‚‰') && experience) {
                        // çµŒé¨“ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã¯ãƒ’ã‚¢ãƒªãƒ³ã‚°å†…å®¹ã‚’ãƒ’ãƒ³ãƒˆã¨ã—ã¦è¿½åŠ 
                        const experienceDraft = generateExperienceDraft(topic, experience, keywords);
                        template += `## ${sectionTitle}\n\n<!-- ãƒ’ãƒ³ãƒˆ: ${experience} -->\n${experienceDraft}\n\nï¼ˆä¸Šè¨˜ã®æ–‡ç« ã‚’å‚è€ƒã«ã€ã‚ˆã‚Šå…·ä½“çš„ãªçµŒé¨“è«‡ã‚’æ›¸ã„ã¦ãã ã•ã„ï¼‰\n\n`;
                    } else if (sectionTitle.includes('å‚è€ƒè¨˜äº‹ã‹ã‚‰å­¦ã¶ãƒã‚¤ãƒ³ãƒˆ')) {
                        // å‚è€ƒè¨˜äº‹å°‚ç”¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³
                        let refHints = `<!-- å‚è€ƒè¨˜äº‹ã®è¦ç´„ã‚’åŸºã«é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’æŠ½å‡º -->\n`;
                        if (window.currentReferenceContent) {
                            refHints += `<!-- å‚è€ƒè¨˜äº‹å†…å®¹: ${window.currentReferenceContent.substring(0, 300)}... -->\n`;
                        }
                        const referenceDraft = generateReferenceDraft(topic, window.currentReferenceContent, keywords);
                        template += `## ${sectionTitle}\n\n${refHints}${referenceDraft}\n\nï¼ˆä¸Šè¨˜ã®æ–‡ç« ã‚’å‚è€ƒã«ã€ã‚ˆã‚Šè©³ç´°ã§å…·ä½“çš„ãªå†…å®¹ã«æ›¸ãæ›ãˆã¦ãã ã•ã„ï¼‰\n\n`;
                    } else if (sectionTitle.includes('ã¨ã¯ï¼Ÿ') || sectionTitle.includes('ã«ã¤ã„ã¦')) {
                        // åŸºæœ¬èª¬æ˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã¯ãƒ’ã‚¢ãƒªãƒ³ã‚°å†…å®¹ã‚’ãƒ’ãƒ³ãƒˆã¨ã—ã¦è¿½åŠ 
                        let hints = `<!-- ãƒ’ãƒ³ãƒˆ: ${purpose} -->\n`;
                        if (keywords) {
                            hints += `<!-- ãƒ¡ã‚¤ãƒ³ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${keywords} -->\n`;
                        }
                        if (subKeywords) {
                            hints += `<!-- ã‚µãƒ–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${subKeywords} -->\n`;
                        }
                        if (referenceUrl) {
                            hints += `<!-- å‚è€ƒè¨˜äº‹: ${referenceUrl} -->\n`;
                            if (window.currentReferenceContent) {
                                hints += `<!-- å‚è€ƒè¨˜äº‹ã®ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒˆ: ${window.currentReferenceContent.substring(0, 150)}... -->\n`;
                            }
                        }
                        const basicDraft = generateBasicExplanationDraft(topic, keywords, subKeywords, purpose);
                        template += `## ${sectionTitle}\n\n${hints}${basicDraft}\n\nï¼ˆä¸Šè¨˜ã®æ–‡ç« ã‚’å‚è€ƒã«ã€ã‚ˆã‚Šè©³ç´°ã§å…·ä½“çš„ãªå†…å®¹ã«æ›¸ãæ›ãˆã¦ãã ã•ã„ï¼‰\n\n`;
                    } else if (sectionTitle.includes('ã¾ã¨ã‚')) {
                        // ã¾ã¨ã‚ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã¯è¨˜äº‹ã®ç›®çš„ã‚’åæ˜ 
                        let summaryHints = `<!-- ãƒ’ãƒ³ãƒˆ: è¨˜äº‹ã®ç›®çš„ - ${purpose} -->\n`;
                        if (window.currentReferenceContent) {
                            summaryHints += `<!-- å‚è€ƒè¨˜äº‹ã®çµè«–ã‚‚è¸ã¾ãˆã¦ã¾ã¨ã‚ã‚‹ -->\n`;
                        }
                        const summaryDraft = generateSummaryDraft(topic, purpose, keywords);
                        template += `## ${sectionTitle}\n\n${summaryHints}${summaryDraft}\n\nï¼ˆä¸Šè¨˜ã®æ–‡ç« ã‚’å‚è€ƒã«ã€ã‚ˆã‚Šè©³ç´°ã§å…·ä½“çš„ãªå†…å®¹ã«æ›¸ãæ›ãˆã¦ãã ã•ã„ï¼‰\n\n`;
                    } else {
                        // ãã®ä»–ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æƒ…å ±ã¨å‚è€ƒURLãŒã‚ã‚Œã°è¿½åŠ 
                        let hints = '';
                        if (keywords || subKeywords) {
                            hints += `<!-- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ´»ç”¨ã®ãƒ’ãƒ³ãƒˆ -->\n`;
                            if (keywords) {
                                hints += `<!-- ãƒ¡ã‚¤ãƒ³ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${keywords} -->\n`;
                            }
                            if (subKeywords) {
                                hints += `<!-- ã‚µãƒ–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${subKeywords} -->\n`;
                            }
                        }
                        if (referenceUrl) {
                            hints += `<!-- å‚è€ƒè¨˜äº‹: ${referenceUrl} -->\n`;
                            if (window.currentReferenceContent) {
                                hints += `<!-- å‚è€ƒæƒ…å ±: ${window.currentReferenceContent.substring(0, 100)}... -->\n`;
                            }
                        }
                        
                        // AIç”Ÿæˆã®ãŸãŸãå°æ–‡ç« ã‚’è¿½åŠ ï¼ˆ200æ–‡å­—ç¨‹åº¦ï¼‰
                        const draftContent = generateSectionDraft(sectionTitle, topic, keywords, subKeywords, purpose, window.currentReferenceContent);
                        template += `## ${sectionTitle}\n\n${hints}${draftContent}\n\nï¼ˆä¸Šè¨˜ã®æ–‡ç« ã‚’å‚è€ƒã«ã€ã‚ˆã‚Šè©³ç´°ã§å…·ä½“çš„ãªå†…å®¹ã«æ›¸ãæ›ãˆã¦ãã ã•ã„ï¼‰\n\n`;
                    }
                });
            }
            
            document.getElementById('content').value = template;
            
            // ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            document.getElementById('editorCard').scrollIntoView({ behavior: 'smooth' });
        }

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æ©Ÿèƒ½
        function saveArticle() {
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            
            if (!title || !content) {
                alert('ã‚¿ã‚¤ãƒˆãƒ«ã¨å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const article = {
                id: Date.now(),
                title: title,
                content: content,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            const savedArticles = JSON.parse(localStorage.getItem('blogArticles') || '[]');
            console.log('ä¿å­˜å‰ã®è¨˜äº‹ä¸€è¦§:', savedArticles);
            console.log('ä¿å­˜å‰ã®è¨˜äº‹æ•°:', savedArticles.length);
            
            savedArticles.push(article);
            console.log('ä¿å­˜å¾Œã®è¨˜äº‹ä¸€è¦§:', savedArticles);
            console.log('ä¿å­˜å¾Œã®è¨˜äº‹æ•°:', savedArticles.length);
            
            localStorage.setItem('blogArticles', JSON.stringify(savedArticles));
            
            // ä¿å­˜ã®ç¢ºèª
            const checkSaved = JSON.parse(localStorage.getItem('blogArticles') || '[]');
            console.log('localStorageç¢ºèª - ä¿å­˜ã•ã‚ŒãŸè¨˜äº‹æ•°:', checkSaved.length);
            
            alert('è¨˜äº‹ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼');
        }

        // AIã«ã‚ˆã‚‹ã€Œã¯ã˜ã‚ã«ã€æ–‡ç« ç”Ÿæˆæ©Ÿèƒ½ï¼ˆä¸€èˆ¬å‘ã‘ã«å›ºå®šã€å‚è€ƒè¨˜äº‹å¯¾å¿œï¼‰
        function generateIntroText(topic, target, purpose, experience, referenceContent = '') {
            const baseTemplate = [
                `${topic}ã«ã¤ã„ã¦é–¢å¿ƒã‚’ãŠæŒã¡ã®çš†ã•ã‚“ã€ã¯ã˜ã‚ã¾ã—ã¦ã€‚`,
                `ã“ã®è¨˜äº‹ã§ã¯ã€${topic}ã®é­…åŠ›ã‚„é‡è¦æ€§ã«ã¤ã„ã¦ã€èª°ã«ã§ã‚‚ç†è§£ã§ãã‚‹å½¢ã§ãŠä¼ãˆã—ã¾ã™ã€‚`,
                `${purpose}ãŸã‚ã«ã€èº«è¿‘ãªä¾‹ã‚’ç”¨ã„ãªãŒã‚‰åˆ†ã‹ã‚Šã‚„ã™ãè§£èª¬ã—ã¦ã„ãã¾ã™ã€‚`
            ];

            // å‚è€ƒè¨˜äº‹ãŒã‚ã‚‹å ´åˆã®è¿½åŠ æ–‡ç« 
            if (referenceContent && referenceContent.length > 50) {
                baseTemplate.push(`ã¾ãŸã€é–¢é€£ã™ã‚‹è¨˜äº‹ã®å†…å®¹ã‚‚å‚è€ƒã«ã—ãªãŒã‚‰ã€ã‚ˆã‚Šæ·±ã„ç†è§£ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚`);
            }

            // çµŒé¨“ã«åŸºã¥ãæ–‡ç« 
            if (experience) {
                baseTemplate.push(`å®Ÿä½“é¨“ã«åŸºã¥ãå…·ä½“çš„ãªã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚‚äº¤ãˆã¦ã”ç´¹ä»‹ã—ã¾ã™ã€‚`);
            } else {
                baseTemplate.push(`æ—¥å¸¸ç”Ÿæ´»ã¨ã®é–¢é€£æ€§ã‚’é‡è¦–ã—ãŸå†…å®¹ã§ãŠå±Šã‘ã—ã¾ã™ã€‚`);
            }

            return baseTemplate.join(' ');
        }

        // AIç”Ÿæˆï¼šä¸­è¦‹å‡ºã—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãŸãŸãå°æ–‡ç« ç”Ÿæˆï¼ˆ200æ–‡å­—ç¨‹åº¦ï¼‰
        function generateSectionDraft(sectionTitle, topic, keywords, subKeywords, purpose, referenceContent) {
            const templates = {
                method: [
                    `${topic}ã‚’åŠ¹æœçš„ã«æ´»ç”¨ã™ã‚‹ãŸã‚ã«ã¯ã€ã¾ãšåŸºæœ¬çš„ãªç†è§£ã‹ã‚‰å§‹ã‚ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚`,
                    `å®Ÿéš›ã®æ‰‹é †ã¨ã—ã¦ã¯ã€æ®µéšçš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’å–ã‚‹ã“ã¨ã§ã€ç¢ºå®Ÿãªæˆæœã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚`,
                    `å…·ä½“çš„ãªæ–¹æ³•ã«ã¤ã„ã¦ã€å®Ÿè·µçš„ãªè¦³ç‚¹ã‹ã‚‰è©³ã—ãè§£èª¬ã—ã¦ã„ãã¾ã™ã€‚`
                ],
                point: [
                    `${topic}ã«ãŠã„ã¦æœ€ã‚‚é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã¯ã€åŸºæœ¬çš„ãªæ¦‚å¿µã‚’ã—ã£ã‹ã‚Šã¨ç†è§£ã™ã‚‹ã“ã¨ã§ã™ã€‚`,
                    `å¤šãã®äººãŒè¦‹è½ã¨ã—ãŒã¡ãªè¦ç´ ã¨ã—ã¦ã€ç¶™ç¶šçš„ãªå–ã‚Šçµ„ã¿ã®é‡è¦æ€§ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚`,
                    `æˆåŠŸäº‹ä¾‹ã‹ã‚‰å­¦ã¶ã“ã¨ã§ã€ã‚ˆã‚ŠåŠ¹æœçš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚`
                ],
                application: [
                    `${topic}ã®å¿œç”¨ä¾‹ã¨ã—ã¦ã€æ§˜ã€…ãªå ´é¢ã§ã®æ´»ç”¨æ–¹æ³•ã‚’è€ƒãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚`,
                    `å®Ÿéš›ã®ç¾å ´ã§ã¯ã€ç†è«–ã ã‘ã§ãªãå®Ÿè·µçš„ãªã‚¹ã‚­ãƒ«ãŒæ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚`,
                    `å…·ä½“çš„ãªå¿œç”¨äº‹ä¾‹ã‚’é€šã˜ã¦ã€ã‚ˆã‚Šæ·±ã„ç†è§£ã‚’ç›®æŒ‡ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚`
                ],
                default: [
                    `${topic}ã«ã¤ã„ã¦è€ƒãˆã‚‹éš›ã«ã¯ã€å¤šè§’çš„ãªè¦–ç‚¹ã‹ã‚‰æ‰ãˆã‚‹ã“ã¨ãŒå¤§åˆ‡ã§ã™ã€‚`,
                    `åŸºæœ¬çš„ãªçŸ¥è­˜ã‚’èº«ã«ã¤ã‘ã‚‹ã“ã¨ã§ã€å¿œç”¨çš„ãªæ´»ç”¨ã‚‚å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚`,
                    `å®Ÿè·µã‚’é€šã˜ã¦å¾—ã‚‰ã‚Œã‚‹çµŒé¨“ãŒã€ã‚ˆã‚Šæ·±ã„ç†è§£ã«ã¤ãªãŒã‚Šã¾ã™ã€‚`
                ]
            };

            let selectedTemplate;
            if (sectionTitle.includes('æ–¹æ³•') || sectionTitle.includes('ã‚„ã‚Šæ–¹')) {
                selectedTemplate = templates.method;
            } else if (sectionTitle.includes('ãƒã‚¤ãƒ³ãƒˆ') || sectionTitle.includes('é‡è¦')) {
                selectedTemplate = templates.point;
            } else if (sectionTitle.includes('å¿œç”¨') || sectionTitle.includes('äº‹ä¾‹')) {
                selectedTemplate = templates.application;
            } else {
                selectedTemplate = templates.default;
            }

            let draft = selectedTemplate.join(' ');
            
            // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰çµ±åˆ
            if (keywords) {
                draft = draft.replace(new RegExp(`${topic}`, 'g'), `${keywords}`);
            }

            return draft;
        }

        // AIç”Ÿæˆï¼šåŸºæœ¬èª¬æ˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãŸãŸãå°æ–‡ç« ç”Ÿæˆ
        function generateBasicExplanationDraft(topic, keywords, subKeywords, purpose) {
            const keywordToUse = keywords || topic;
            return `${keywordToUse}ã¨ã¯ã€${purpose}ã®ãŸã‚ã®é‡è¦ãªæ¦‚å¿µã§ã™ã€‚ä¸€èˆ¬çš„ã«ã€${keywordToUse}ã¯æ—¥å¸¸ç”Ÿæ´»ã®æ§˜ã€…ãªå ´é¢ã§æ´»ç”¨ã•ã‚Œã¦ãŠã‚Šã€å¤šãã®äººã«ã¨ã£ã¦èº«è¿‘ãªå­˜åœ¨ã¨ãªã£ã¦ã„ã¾ã™ã€‚åŸºæœ¬çš„ãªç‰¹å¾´ã¨ã—ã¦ã€ç†è§£ã—ã‚„ã™ãå®Ÿè·µçš„ã§ã‚ã‚‹ã“ã¨ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚ã“ã®æ¦‚å¿µã‚’æ­£ã—ãç†è§£ã™ã‚‹ã“ã¨ã§ã€ã‚ˆã‚ŠåŠ¹æœçš„ã«æ´»ç”¨ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚`;
        }

        // AIç”Ÿæˆï¼šçµŒé¨“è«‡ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãŸãŸãå°æ–‡ç« ç”Ÿæˆ
        function generateExperienceDraft(topic, experience, keywords) {
            const keywordToUse = keywords || topic;
            return `ç§è‡ªèº«ã®çµŒé¨“ã‚’æŒ¯ã‚Šè¿”ã‚‹ã¨ã€${keywordToUse}ã¨ã®å‡ºä¼šã„ã¯éå¸¸ã«å°è±¡æ·±ã„ã‚‚ã®ã§ã—ãŸã€‚æœ€åˆã¯åˆ†ã‹ã‚‰ãªã„ã“ã¨ãŒå¤šãæˆ¸æƒ‘ã„ã¾ã—ãŸãŒã€å®Ÿéš›ã«å–ã‚Šçµ„ã‚“ã§ã¿ã‚‹ã“ã¨ã§å¾ã€…ã«ç†è§£ãŒæ·±ã¾ã‚Šã¾ã—ãŸã€‚ç‰¹ã«å°è±¡çš„ã ã£ãŸã®ã¯ã€ç†è«–ã¨å®Ÿè·µã®ã‚®ãƒ£ãƒƒãƒ—ã‚’æ„Ÿã˜ãŸç¬é–“ã§ã™ã€‚å®Ÿä½“é¨“ã‚’é€šã˜ã¦å­¦ã‚“ã ã“ã¨ã¯ã€æ›¸ç±ã‚„æƒ…å ±ã ã‘ã§ã¯å¾—ã‚‰ã‚Œãªã„è²´é‡ãªå­¦ã³ã¨ãªã‚Šã¾ã—ãŸã€‚`;
        }

        // AIç”Ÿæˆï¼šå‚è€ƒè¨˜äº‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãŸãŸãå°æ–‡ç« ç”Ÿæˆ
        function generateReferenceDraft(topic, referenceContent, keywords) {
            const keywordToUse = keywords || topic;
            return `å‚è€ƒè¨˜äº‹ã®å†…å®¹ã‚’åˆ†æã™ã‚‹ã¨ã€${keywordToUse}ã«é–¢ã™ã‚‹é‡è¦ãªãƒã‚¤ãƒ³ãƒˆãŒã„ãã¤ã‹æµ®ã‹ã³ä¸ŠãŒã£ã¦ãã¾ã™ã€‚ç‰¹ã«æ³¨ç›®ã™ã¹ãç‚¹ã¨ã—ã¦ã€å®Ÿè·µçš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®é‡è¦æ€§ãŒå¼·èª¿ã•ã‚Œã¦ã„ã¾ã™ã€‚ã¾ãŸã€ç¶™ç¶šçš„ãªå–ã‚Šçµ„ã¿ã®å¿…è¦æ€§ã«ã¤ã„ã¦ã‚‚è¨€åŠã•ã‚Œã¦ãŠã‚Šã€ä¸€åº¦ãã‚Šã®å–ã‚Šçµ„ã¿ã§ã¯ãªãé•·æœŸçš„ãªè¦–ç‚¹ãŒé‡è¦ã§ã‚ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚ã“ã‚Œã‚‰ã®çŸ¥è¦‹ã‚’è¸ã¾ãˆã¦ã€å®Ÿéš›ã®æ´»ç”¨æ–¹æ³•ã‚’è€ƒãˆã¦ã„ãã¾ã—ã‚‡ã†ã€‚`;
        }

        // AIç”Ÿæˆï¼šã¾ã¨ã‚ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãŸãŸãå°æ–‡ç« ç”Ÿæˆ
        function generateSummaryDraft(topic, purpose, keywords) {
            const keywordToUse = keywords || topic;
            return `ä»Šå›ã®è¨˜äº‹ã§ã¯ã€${keywordToUse}ã«ã¤ã„ã¦è©³ã—ãè§£èª¬ã—ã¦ãã¾ã—ãŸã€‚${purpose}ã¨ã„ã†ç›®çš„ã«ãŠã„ã¦ã€åŸºæœ¬çš„ãªç†è§£ã‹ã‚‰å®Ÿè·µçš„ãªæ´»ç”¨æ–¹æ³•ã¾ã§ã€å¹…åºƒã„å†…å®¹ã‚’ã‚«ãƒãƒ¼ã—ã¾ã—ãŸã€‚é‡è¦ãªã®ã¯ã€çŸ¥è­˜ã‚’å¾—ã‚‹ã ã‘ã§ãªãå®Ÿéš›ã«è¡Œå‹•ã«ç§»ã™ã“ã¨ã§ã™ã€‚ã¾ãšã¯å°ã•ãªä¸€æ­©ã‹ã‚‰å§‹ã‚ã¦ã€å¾ã€…ã«çµŒé¨“ã‚’ç©ã¿é‡ã­ã¦ã„ãã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚çš†ã•ã‚“ã®å–ã‚Šçµ„ã¿ãŒæˆåŠŸã«ã¤ãªãŒã‚‹ã“ã¨ã‚’é¡˜ã£ã¦ã„ã¾ã™ã€‚`;
        }

        // ä¿å­˜æ¸ˆã¿è¨˜äº‹ä¸€è¦§è¡¨ç¤ºæ©Ÿèƒ½
        function showSavedArticlesList() {
            const savedArticles = JSON.parse(localStorage.getItem('blogArticles') || '[]');
            console.log('showSavedArticlesList - å–å¾—ã—ãŸè¨˜äº‹ãƒ‡ãƒ¼ã‚¿:', savedArticles);
            console.log('è¨˜äº‹æ•°:', savedArticles.length);
            
            // TOPãƒšãƒ¼ã‚¸ã‹ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ãƒšãƒ¼ã‚¸ã‹ã‚’åˆ¤å®š
            const articlesList = document.getElementById('topArticlesList') || document.getElementById('articlesList');
            
            if (savedArticles.length === 0) {
                articlesList.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">ä¿å­˜ã•ã‚ŒãŸè¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                articlesList.classList.remove('hidden');
                return;
            }

            // è¨˜äº‹ã‚’æ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆï¼ˆå…ƒã®é…åˆ—ã‚’å¤‰æ›´ã›ãšã«ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆï¼‰
            const sortedArticles = [...savedArticles].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            console.log('ã‚½ãƒ¼ãƒˆå¾Œã®è¨˜äº‹:', sortedArticles);

            const listHTML = sortedArticles.map((article, sortedIndex) => {
                const preview = article.content.replace(/#+\s*/g, '').substring(0, 80) + '...';
                // å…ƒã®é…åˆ—ã§ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½¿ç”¨
                const originalIndex = savedArticles.findIndex(item => item.id === article.id);
                console.log(`è¨˜äº‹ "${article.title}" - ã‚½ãƒ¼ãƒˆå¾Œindex: ${sortedIndex}, å…ƒã®index: ${originalIndex}`);
                return `
                    <div class="article-item" onclick="loadArticleByIndex(${originalIndex})">
                        <h4>${article.title}</h4>
                        <div class="article-date">${new Date(article.createdAt).toLocaleDateString('ja-JP')}</div>
                        <div class="article-preview">${preview}</div>
                    </div>
                `;
            }).join('');

            articlesList.innerHTML = `
                <h3 style="margin-bottom: 15px; color: #2c3e50;">ğŸ“š ä¿å­˜æ¸ˆã¿è¨˜äº‹ä¸€è¦§</h3>
                ${listHTML}
                <button onclick="hideArticlesList()" style="margin-top: 15px; background: #95a5a6;">ä¸€è¦§ã‚’é–‰ã˜ã‚‹</button>
            `;
            articlesList.classList.remove('hidden');
        }

        function hideArticlesList() {
            const topList = document.getElementById('topArticlesList');
            const editorList = document.getElementById('articlesList');
            if (topList) topList.classList.add('hidden');
            if (editorList) editorList.classList.add('hidden');
        }

        function loadArticleByIndex(index) {
            try {
                const savedArticles = JSON.parse(localStorage.getItem('blogArticles') || '[]');
                console.log('ä¿å­˜æ¸ˆã¿è¨˜äº‹ãƒ‡ãƒ¼ã‚¿:', savedArticles);
                console.log('é¸æŠã•ã‚ŒãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:', index);
                
                if (savedArticles[index]) {
                    const article = savedArticles[index];
                    console.log('èª­ã¿è¾¼ã‚€è¨˜äº‹:', article);
                    
                    // ç·¨é›†ç”»é¢ã‚’è¡¨ç¤º
                    const editorCard = document.getElementById('editorCard');
                    if (editorCard) {
                        editorCard.classList.remove('hidden');
                        console.log('ç·¨é›†ç”»é¢ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
                    }
                    
                    // è¨˜äº‹å†…å®¹ã‚’ç·¨é›†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®š
                    const titleField = document.getElementById('title');
                    const contentField = document.getElementById('content');
                    
                    console.log('ã‚¿ã‚¤ãƒˆãƒ«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰:', titleField);
                    console.log('ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰:', contentField);
                    
                    if (titleField && contentField) {
                        // ç¢ºå®Ÿã«å€¤ã‚’è¨­å®š
                        titleField.value = String(article.title || '');
                        contentField.value = String(article.content || '');
                        
                        console.log('è¨­å®šã•ã‚ŒãŸã‚¿ã‚¤ãƒˆãƒ«:', titleField.value);
                        console.log('è¨­å®šã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„:', contentField.value);
                        
                        // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æœ‰åŠ¹åŒ–
                        titleField.disabled = false;
                        contentField.disabled = false;
                        
                        // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å½“ã¦ã¦ç·¨é›†å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’æ˜ç¢ºã«
                        setTimeout(() => {
                            titleField.focus();
                            titleField.select();
                        }, 300);
                    } else {
                        console.error('ç·¨é›†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                        alert('ç·¨é›†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }
                    
                    // ä¸€è¦§ã‚’éè¡¨ç¤º
                    hideArticlesList();
                    
                    // ç·¨é›†ç”»é¢ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                    setTimeout(() => {
                        if (editorCard) {
                            editorCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }, 400);
                    
                    alert(`ã€Œ${article.title}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚ç·¨é›†ã—ã¦ãã ã•ã„ã€‚`);
                } else {
                    console.error('è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:', index);
                    alert('é¸æŠã•ã‚ŒãŸè¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
            } catch (error) {
                console.error('è¨˜äº‹èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                alert('è¨˜äº‹ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        function loadSavedArticles() {
            const savedArticles = JSON.parse(localStorage.getItem('blogArticles') || '[]');
            if (savedArticles.length === 0) {
                alert('ä¿å­˜ã•ã‚ŒãŸè¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            const articleList = savedArticles.map((article, index) => 
                `${index + 1}. ${article.title} (${new Date(article.createdAt).toLocaleDateString('ja-JP')})`
            ).join('\n');
            
            const selection = prompt(`ä¿å­˜æ¸ˆã¿è¨˜äº‹:\n${articleList}\n\nèª­ã¿è¾¼ã¿ãŸã„è¨˜äº‹ã®ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (1-${savedArticles.length})`);
            
            if (selection && !isNaN(selection) && selection >= 1 && selection <= savedArticles.length) {
                const selectedArticle = savedArticles[selection - 1];
                document.getElementById('title').value = selectedArticle.title;
                document.getElementById('content').value = selectedArticle.content;
                alert(`ã€Œ${selectedArticle.title}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
            }
        }

        function previewArticle() {
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            
            if (!title || !content) {
                alert('ã‚¿ã‚¤ãƒˆãƒ«ã¨å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const previewWindow = window.open('', '_blank');
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${title}</title>
                    <style>
                        body { font-family: 'Hiragino Sans', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
                        h1, h2, h3 { color: #2c3e50; }
                        pre { background: #f4f4f4; padding: 15px; border-radius: 5px; }
                        code { background: #f4f4f4; padding: 2px 4px; border-radius: 3px; }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    <div>${content.replace(/\n/g, '<br>')}</div>
                </body>
                </html>
            `);
        }

        // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šlocalStorageå†…å®¹ç¢ºèªé–¢æ•°
        function debugLocalStorage() {
            const data = localStorage.getItem('blogArticles');
            console.log('localStorage raw data:', data);
            
            if (data) {
                try {
                    const parsed = JSON.parse(data);
                    console.log('Parsed articles:', parsed);
                    console.log('Number of articles:', parsed.length);
                    
                    parsed.forEach((article, index) => {
                        console.log(`Article ${index + 1}:`, article.title, '- Created:', article.createdAt);
                    });
                    
                    alert(`localStorageå†…ã«${parsed.length}ä»¶ã®è¨˜äº‹ãŒã‚ã‚Šã¾ã™ã€‚è©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
                } catch (error) {
                    console.error('JSON parse error:', error);
                    alert('localStorageã®ãƒ‡ãƒ¼ã‚¿ãŒå£Šã‚Œã¦ã„ã¾ã™');
                }
            } else {
                alert('localStorageã«è¨˜äº‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
            }
        }

        // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šlocalStorageå®Œå…¨ã‚¯ãƒªã‚¢
        function clearAllArticles() {
            if (confirm('å…¨ã¦ã®ä¿å­˜æ¸ˆã¿è¨˜äº‹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                localStorage.removeItem('blogArticles');
                alert('å…¨ã¦ã®è¨˜äº‹ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ');
                console.log('localStorage cleared');
            }
        }
    </script>
</body>
</html>